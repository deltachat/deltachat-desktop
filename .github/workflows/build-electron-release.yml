name: Build Electron Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  # ── Linux x86_64 ──────────────────────────────────────────────
  build-linux-x64:
    runs-on: ubuntu-latest
    name: Linux x64
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y rpm

      - name: Install and build
        run: |
          npm i -g pnpm
          pnpm install --frozen-lockfile

      - name: Build frontend
        working-directory: packages/target-electron
        env:
          NODE_ENV: production
        run: |
          pnpm build
          pnpm -w check:types
          pnpm run pack:patch-node-modules
          pnpm run pack:generate_config

      - name: Package Linux x64
        working-directory: packages/target-electron
        run: |
          pnpm electron-builder \
            --publish never \
            --config ./electron-builder.json5 \
            --arm64=false --x64 \
            --linux AppImage deb rpm tar.gz pacman

      - uses: actions/upload-artifact@v4
        with:
          name: electron-linux-x64
          path: |
            packages/target-electron/dist/*.AppImage
            packages/target-electron/dist/*.deb
            packages/target-electron/dist/*.rpm
            packages/target-electron/dist/*.tar.gz
            packages/target-electron/dist/*.pacman

  # ── Linux arm64 ──────────────────────────────────────────────
  build-linux-arm64:
    runs-on: ubuntu-latest
    name: Linux arm64
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y rpm

      - name: Install and build
        run: |
          npm i -g pnpm
          pnpm install --frozen-lockfile

      - name: Build frontend
        working-directory: packages/target-electron
        env:
          NODE_ENV: production
        run: |
          pnpm build
          pnpm -w check:types
          pnpm run pack:patch-node-modules
          pnpm run pack:generate_config

      - name: Package Linux arm64
        working-directory: packages/target-electron
        run: |
          pnpm electron-builder \
            --publish never \
            --config ./electron-builder.json5 \
            --arm64 \
            --linux AppImage deb rpm tar.gz pacman

      - uses: actions/upload-artifact@v4
        with:
          name: electron-linux-arm64
          path: |
            packages/target-electron/dist/*.AppImage
            packages/target-electron/dist/*.deb
            packages/target-electron/dist/*.rpm
            packages/target-electron/dist/*.tar.gz
            packages/target-electron/dist/*.pacman

  # ── Windows (x64 + ia32) ─────────────────────────────────────
  build-windows:
    runs-on: windows-latest
    name: Windows x64 + ia32
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Install and build
        shell: bash
        run: |
          npm i -g pnpm
          pnpm install --frozen-lockfile

      - name: Build frontend
        shell: bash
        working-directory: packages/target-electron
        env:
          NODE_ENV: production
        run: |
          pnpm build
          pnpm -w check:types
          pnpm run pack:patch-node-modules
          pnpm run pack:generate_config

      - name: Package Windows x64
        shell: bash
        working-directory: packages/target-electron
        run: |
          pnpm electron-builder \
            --publish never \
            --config ./electron-builder.json5 \
            --x64 --win nsis portable

      - name: Package Windows ia32
        shell: bash
        working-directory: packages/target-electron
        run: |
          pnpm electron-builder \
            --publish never \
            --config ./electron-builder.json5 \
            --ia32 --win nsis portable

      - name: Package Windows appx
        shell: bash
        working-directory: packages/target-electron
        run: |
          pnpm electron-builder \
            --publish never \
            --config ./electron-builder.json5 \
            --win appx

      - uses: actions/upload-artifact@v4
        with:
          name: electron-windows
          path: |
            packages/target-electron/dist/*.exe
            packages/target-electron/dist/*.appx

  # ── macOS DMG (universal + arm64, signed + notarized) ────────
  build-mac-dmg:
    runs-on: macos-latest
    name: macOS DMG (signed + notarized)
    environment: release-builds
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Set up signing keychain
        env:
          DEVELOPER_ID_APP_CERT_P12: ${{ secrets.DEVELOPER_ID_APP_CERT_P12 }}
          DEVELOPER_ID_CERT_PASSWORD: ${{ secrets.DEVELOPER_ID_CERT_PASSWORD }}
        run: |
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"
          KEYCHAIN_PASSWORD="$(openssl rand -base64 32)"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          CERT_PATH="$RUNNER_TEMP/dev_id_cert.p12"
          echo "$DEVELOPER_ID_APP_CERT_P12" | base64 --decode > "$CERT_PATH"
          security import "$CERT_PATH" \
            -k "$KEYCHAIN_PATH" \
            -P "$DEVELOPER_ID_CERT_PASSWORD" \
            -T /usr/bin/codesign
          rm "$CERT_PATH"

          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | tr -d '"')

          echo "=== Signing identities ==="
          security find-identity -v -p codesigning "$KEYCHAIN_PATH"

      - name: Set up Apple API key for notarization
        env:
          APPLE_API_KEY_P8_BASE64: ${{ secrets.APPLE_API_KEY_P8_BASE64 }}
        run: |
          API_KEY_PATH="$RUNNER_TEMP/AuthKey.p8"
          echo "$APPLE_API_KEY_P8_BASE64" | base64 --decode > "$API_KEY_PATH"
          echo "appleApiKey=$API_KEY_PATH" >> $GITHUB_ENV
          echo "appleApiKeyId=${{ secrets.APPLE_API_KEY_ID }}" >> $GITHUB_ENV
          echo "appleApiIssuer=${{ secrets.APPLE_API_ISSUER }}" >> $GITHUB_ENV

      - name: Decode provisioning profile
        run: |
          echo "${{ secrets.MAS_PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > embedded.provisionprofile

      - name: Install and build
        run: |
          npm i -g pnpm
          pnpm install --frozen-lockfile

      - name: Build frontend
        working-directory: packages/target-electron
        env:
          NODE_ENV: production
        run: |
          pnpm build
          pnpm -w check:types
          pnpm run pack:patch-node-modules
          pnpm run pack:generate_config
          pnpm i dmg-license

      - name: Build universal DMG
        working-directory: packages/target-electron
        run: |
          pnpm electron-builder \
            --publish never \
            --config ./electron-builder.json5 \
            --universal --mac dmg \
            -c.mac.provisioningProfile=../../embedded.provisionprofile

      - name: Build arm64 DMG
        working-directory: packages/target-electron
        run: |
          pnpm electron-builder \
            --publish never \
            --config ./electron-builder.json5 \
            --arm64 --mac dmg \
            -c.mac.provisioningProfile=../../embedded.provisionprofile

      - name: Clean up keychain
        if: always()
        run: |
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"
          [ -f "$KEYCHAIN_PATH" ] && security delete-keychain "$KEYCHAIN_PATH"
          rm -f "$RUNNER_TEMP/AuthKey.p8"

      - uses: actions/upload-artifact@v4
        with:
          name: electron-mac-dmg
          path: packages/target-electron/dist/*.dmg

  # ── MAS .pkg (universal, signed) ─────────────────────────────
  build-mas:
    runs-on: macos-latest
    name: MAS .pkg (signed)
    environment: release-builds
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Set up signing keychain
        env:
          MAS_APP_CERT_P12: ${{ secrets.MAS_APP_CERT_P12 }}
          MAS_INSTALLER_CERT_P12: ${{ secrets.MAS_INSTALLER_CERT_P12 }}
          MAS_CERT_PASSWORD: ${{ secrets.MAS_CERT_PASSWORD }}
        run: |
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"
          KEYCHAIN_PASSWORD="$(openssl rand -base64 32)"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          APP_CERT_PATH="$RUNNER_TEMP/app_cert.p12"
          echo "$MAS_APP_CERT_P12" | base64 --decode > "$APP_CERT_PATH"
          security import "$APP_CERT_PATH" \
            -k "$KEYCHAIN_PATH" \
            -P "$MAS_CERT_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/productbuild
          rm "$APP_CERT_PATH"

          INSTALLER_CERT_PATH="$RUNNER_TEMP/installer_cert.p12"
          echo "$MAS_INSTALLER_CERT_P12" | base64 --decode > "$INSTALLER_CERT_PATH"
          security import "$INSTALLER_CERT_PATH" \
            -k "$KEYCHAIN_PATH" \
            -P "$MAS_CERT_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/productbuild
          rm "$INSTALLER_CERT_PATH"

          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | tr -d '"')

          echo "=== Signing identities ==="
          security find-identity -v -p codesigning "$KEYCHAIN_PATH"

      - name: Decode provisioning profile
        run: |
          echo "${{ secrets.MAS_PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > embedded.provisionprofile

      - name: Install and build
        run: |
          npm i -g pnpm
          pnpm install --frozen-lockfile

      - name: Build frontend
        working-directory: packages/target-electron
        env:
          NODE_ENV: production
        run: |
          pnpm build
          pnpm -w check:types
          pnpm run pack:patch-node-modules
          pnpm run pack:generate_config
          pnpm i dmg-license

      - name: Build and sign MAS universal
        working-directory: packages/target-electron
        run: |
          pnpm electron-builder \
            --publish never \
            --config ./electron-builder.json5 \
            --universal --mac mas \
            -c.mac.provisioningProfile=../../embedded.provisionprofile

      - name: Verify .pkg signature
        working-directory: packages/target-electron
        run: |
          PKG=$(find dist/mas-universal -name "*.pkg" | head -1)
          if [ -n "$PKG" ]; then
            echo "Verifying: $PKG"
            pkgutil --check-signature "$PKG"
          else
            echo "WARNING: No .pkg found"
          fi

      - name: Clean up keychain
        if: always()
        run: |
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"
          [ -f "$KEYCHAIN_PATH" ] && security delete-keychain "$KEYCHAIN_PATH"

      - uses: actions/upload-artifact@v4
        with:
          name: mas-universal-signed
          path: packages/target-electron/dist/mas-universal/*.pkg
          retention-days: 30
